# Web SPA v0 ‚Äî MVP Implementation Plan

## Overview

Build a zero-dependency vanilla JS SPA that lets users paste or upload text, annotate with Comments and Suggestions via mouse selection, view a notes list, and export a summary or `.fem` download. No framework, no WASM, no backend. FEM parsing reimplemented in JS (~50 lines of regex, matching `internal/fem/markers.go` + `parser.go`).

**Debate doc**: `debates/2026-02-11-web-ux-for-general-audience.md`
**Research**: `research/2026-02-11-web-ux-rule-of-5-review.md`, `research/2026-02-10-wasm-web-spa-integration.md`

## Core User Journey (v0)

```
Landing page ‚Üí Paste text / upload file ‚Üí Plain-text reading view
‚Üí Select text (drag) ‚Üí Floating toolbar (Comment / Suggest)
‚Üí Type annotation ‚Üí Submit ‚Üí See highlight + note in sidebar
‚Üí "Finish review" ‚Üí Copy summary / Download .fem
```

## Desired End State

- Single `web/` directory in repo with `index.html`, CSS, and JS modules
- `just serve-web` launches local dev server
- No build step, no bundler, no npm ‚Äî ES modules loaded directly
- IndexedDB for session persistence, autosave on every change
- Desktop-only (graceful "best on desktop" message on small screens)
- Bundle < 100KB (no dependencies)
- Privacy footer: "Runs locally in your browser. Your text never leaves your device."

## Key Design Decision: Plain Text Viewer for v0

The debate doc identifies rendered-markdown anchoring as TF-001 (CRITICAL risk) and offers a fallback: "display as lightly-styled plain text." For v0, we take the fallback as the **default**:

- Document displays as **styled plain text** (monospace, preserved line breaks, code blocks with background color)
- Canonical text buffer == displayed text (byte-for-byte after CRLF‚ÜíLF normalization)
- Selection offsets are trivially correct ‚Äî no DOM-to-source mapping layer needed
- Rendered markdown is a **v1 enhancement**, gated behind passing conformance tests for offset mapping

This eliminates the hardest technical problem from the MVP and lets us validate the core user journey (paste ‚Üí annotate ‚Üí export) with confidence.

## Debate Doc Contradiction: Suggest Marker Syntax

The debate doc (line 153) maps Suggest to `{=> replacement text <=}`, but the Go implementation (`internal/fem/markers.go`) uses `{++ replacement text ++}` for the `change` type. **The Go implementation is the source of truth.** The web JS parser must use `{++ ++}` for CLI round-trip compatibility. The debate doc should be updated separately.

---

## Phase 1: Project Scaffold + Landing Page (~2h)

### Changes Required

**Directory: `web/` (new)**

```
web/
‚îú‚îÄ‚îÄ index.html          # Single page, entry point
‚îú‚îÄ‚îÄ style.css           # All styling
‚îú‚îÄ‚îÄ app.js              # App shell, router (hash-based)
‚îú‚îÄ‚îÄ fem.js              # FEM parser/serializer (port from Go)
‚îú‚îÄ‚îÄ storage.js          # IndexedDB wrapper
‚îú‚îÄ‚îÄ viewer.js           # Plain-text document viewer + offset tracking
‚îú‚îÄ‚îÄ editor.js           # Editor orchestrator + annotation UI
‚îú‚îÄ‚îÄ toolbar.js          # Floating selection toolbar
‚îú‚îÄ‚îÄ notes.js            # Notes list sidebar
‚îî‚îÄ‚îÄ export.js           # "Finish review" screen
```

**File: `web/index.html`**

- Single HTML page with `<div id="app">` root
- ES module `<script type="module" src="app.js">`
- Meta viewport tag (for mobile detection)
- No external CSS/JS dependencies

**File: `web/style.css`**

- CSS custom properties for theming (light theme, no dark mode in v0)
- Layout: centered container for landing, two-pane (doc + notes) for editor
- Floating toolbar styles (absolute positioning near selection)
- Privacy footer styling (persistent, bottom of page)

**File: `web/app.js`**

- Hash-based router: `#/` (landing), `#/review/:id` (editor), `#/finish/:id` (export)
- Renders landing page by default: paste textarea + file drop zone + onboarding copy
- Mobile detection: if `screen.width < 768`, show "Best on desktop" message
- On "Start review": stores content in-memory, navigates to editor. Persistence added in Phase 3.

**Input normalization:** All input is normalized CRLF‚ÜíLF on import. This is the canonical form used everywhere (offsets, hashing, export).

**Landing page content:**

```
Review AI outputs. Annotate with comments and suggestions.
Export a structured summary.

Your text stays on your device ‚Äî nothing is uploaded.

[Large textarea: "Paste text to review"]
[Submit button: "Start review"]

‚Äî or ‚Äî

[Drop zone: "Drop a .md, .txt, or code file here"]
```

**File: `justfile` (additions)**

```
# Serve web SPA locally
serve-web:
    python3 -m http.server 8080 --directory web
```

### Success Criteria

- [ ] `just serve-web` opens landing page at localhost:8080
- [ ] Paste text + click "Start review" navigates to `#/review/:id` (in-memory session)
- [ ] Drag-and-drop file reads content via File API
- [ ] `.md`, `.txt`, `.go`, `.py` accepted (`.fem` import deferred to v1)
- [ ] Mobile shows "best on desktop" message
- [ ] Privacy footer visible on all pages

### Dependencies

None ‚Äî this is the starting phase. Uses in-memory state; IndexedDB persistence added in Phase 3.

---

## Phase 2: FEM Parser in JS (~1.5h)

### Changes Required

**File: `web/fem.js`**

Port `internal/fem/markers.go` and `internal/fem/parser.go` to JavaScript:

```js
// Annotation types ‚Äî single source of truth (mirrors Go AnnotationTypes)
// Order MUST match internal/fem/markers.go for deterministic parsing
export const ANNOTATION_TYPES = [
  { name: 'comment',  open: '{>>', close: '<<}' },
  { name: 'delete',   open: '{--', close: '--}' },
  { name: 'question', open: '{??', close: '??}' },
  { name: 'expand',   open: '{!!', close: '!!}' },
  { name: 'keep',     open: '{==', close: '==}' },
  { name: 'unclear',  open: '{~~', close: '~~}' },
  { name: 'change',   open: '{++', close: '++}' },
  // UI exposes only 'comment' and 'change' (labeled "Suggest") in v0,
  // but parser handles all 7 for .fem export compatibility
];

// parse(content) ‚Üí { annotations: [...], cleanContent: string }
export function parse(content) { ... }

// serialize(cleanContent, annotations) ‚Üí string (FEM format with frontmatter)
export function serialize(sessionId, createdAt, sourceFile, cleanContent, annotations) { ... }

// quoteYAMLString / unquoteYAMLString ‚Äî must match session.go behavior
// Single-quote wrapping, doubled single-quotes for escaping
export function quoteYAMLString(s) { return "'" + s.replaceAll("'", "''") + "'"; }
```

**Key details:**
- Regex patterns built from `ANNOTATION_TYPES` (same as Go `patterns` map)
- Nested marker detection (same as Go `containsNestedMarker`)
- Frontmatter parsing (same `---\n...\n---\n` format as `session.go`)
- Frontmatter keys: `session_id`, `created_at` (RFC3339), optional `source_file` (YAML single-quote escaped)
- Line numbers are 1-indexed, frontmatter excluded (same as Go)

**File: `web/fem.test.html`** (or inline test runner)

Simple test page that runs FEM parse/serialize assertions in the browser console. Not a full test framework ‚Äî just a script that logs PASS/FAIL for known FEM inputs matching `internal/fem/parser_test.go` cases.

### Success Criteria

- [ ] `parse()` handles all 7 annotation types
- [ ] `parse()` strips annotations and returns clean content
- [ ] `serialize()` produces valid FEM that Go `fem.Parse()` can read
- [ ] Nested marker rejection matches Go behavior
- [ ] Frontmatter parsing/generation matches `session.go` format
- [ ] Test cases from `parser_test.go` pass in JS

### Dependencies

None ‚Äî pure logic, no DOM.

---

## Phase 3: IndexedDB Storage Layer (~1h)

### Changes Required

**File: `web/storage.js`**

```js
// Database: fabbro-sessions (IndexedDB)
// Object store: sessions
// Key: sessionId (string)
// Schema mirrors session.go Session struct:
//   { id, content, createdAt, sourceFile, annotations }

export async function init()                          // Open/create DB
export async function createSession(content, sourceFile) // ‚Üí session object
export async function loadSession(id)                 // ‚Üí session or null
export async function saveSession(session)            // Update in place (autosave)
export async function listSessions()                  // ‚Üí sorted by createdAt desc
```

**ID generation:** `YYYYMMDD-` + 16 hex chars (`[0-9a-f]`) from `crypto.getRandomValues()` ‚Äî matches Go `generateID()` format (8 random bytes ‚Üí 16 hex chars).

**Storage schema:**
```js
{
  id: "20260218-a1b2c3d4e5f67890",
  content: "raw text without annotations",
  createdAt: "2026-02-18T12:00:00Z",
  sourceFile: "readme.md",         // from upload filename, empty for paste
  annotations: [                   // stored separately from content
    { type: "comment", text: "...", startOffset: 42, endOffset: 87, snippetHash: "..." }
  ]
}
```

### Success Criteria

- [ ] `createSession()` stores and retrieves correctly
- [ ] `saveSession()` updates annotations (autosave path)
- [ ] `listSessions()` returns newest-first
- [ ] Works in Firefox, Chrome, Safari

### Dependencies

None ‚Äî pure storage logic.

---

## Phase 4: Plain-Text Document Viewer (~1h)

### Changes Required

**File: `web/viewer.js`**

Renders canonical text as styled plain text. Because displayed text == canonical text (byte-for-byte), selection offsets are trivially correct.

```js
export function render(container, content)  // Render content into scrollable container
export function getOffsets(selection)        // Selection ‚Üí { startOffset, endOffset }
```

**Rendering approach:**

- Split content by `\n` into line `<div>` elements
- Each line `<div>` carries `data-start` attribute (cumulative character offset)
- Monospace font (`font-family: 'SF Mono', 'Fira Code', monospace`)
- Line numbers in a gutter column (subtle, gray)
- Soft word-wrap within lines
- Code fence blocks (``` markers) get a subtle background color

**Offset computation:**

Since displayed text == canonical text, `getOffsets()` is straightforward:
1. Find the line `<div>` containing the selection anchor/focus
2. Read its `data-start` attribute
3. Add the text offset within the line's text node
4. Result: exact character offsets into `session.content`

No normalization layer, no DOM-to-source mapping ‚Äî this is why we chose plain text for v0.

### Success Criteria

- [ ] Content renders with line numbers and monospace styling
- [ ] `getOffsets()` returns correct character offsets for any selection
- [ ] `content.slice(startOffset, endOffset)` matches the visually selected text
- [ ] Long lines wrap naturally
- [ ] Scrollable for large documents
- [ ] No external dependencies

### Dependencies

None ‚Äî pure rendering logic.

---

## Phase 5: Document Viewer + Selection ‚Üí Annotation (~3h)

This is the core interaction. The hardest phase.

### Changes Required

**File: `web/editor.js`**

Main editor view: renders document, handles text selection, creates annotations.

```js
export function mount(container, session)  // Render editor into container
export function unmount()                   // Cleanup listeners
```

**Rendering:**
1. Use `viewer.js` to render `session.content` as styled plain text
2. Overlay annotation highlights on annotated ranges (yellow background via wrapping text in `<mark>`)
3. Show `‚óè` gutter indicators on annotated lines

**Selection ‚Üí annotation flow (debate doc Decision 1):**

1. User drags to select text in the document
2. On `mouseup`, detect selection via `window.getSelection()`
3. Get canonical text offsets via `viewer.getOffsets(selection)` (trivial ‚Äî plain text, no mapping needed)
4. Show floating toolbar near selection (above/below, see `toolbar.js`)
5. User clicks "Comment" or "Suggest"
6. Show inline `<textarea>` input below the selection
7. On submit (Enter): create annotation, save to storage (autosave), re-render highlights
8. On cancel (Esc): dismiss input

**Snippet hash:** SHA-256 of the selected text (via `crypto.subtle.digest`), stored with annotation for drift detection at export time.

**File: `web/toolbar.js`**

Floating toolbar component:

```js
export function show(x, y, onComment, onSuggest)  // Position near selection
export function hide()
```

- Two buttons: "Comment" (üí¨) and "Suggest" (‚úèÔ∏è)
- Microcopy below: "Comments add feedback. Suggestions propose replacement text."
- Positioned above selection if room, below if not
- Dismissed on click outside or Esc

**Annotation highlights:**

Annotated text ranges get a `<mark>` wrapper. For v0, overlapping annotations use "last highlight wins" (later annotation's highlight is outermost). Click on highlight ‚Üí focus corresponding note in sidebar. Overlap refinement is a v1 concern.

### Success Criteria

- [ ] Select text ‚Üí toolbar appears near selection
- [ ] Click "Comment" ‚Üí text input appears ‚Üí submit creates annotation
- [ ] Click "Suggest" ‚Üí text input with "Replacement:" label ‚Üí submit creates change annotation
- [ ] Annotation highlight visible on the text
- [ ] Click highlight ‚Üí scrolls to note in sidebar
- [ ] Autosave fires on every annotation add
- [ ] "Saved locally" indicator updates
- [ ] Esc dismisses toolbar and input

### Dependencies

Phase 2 (fem.js), Phase 3 (storage.js), Phase 4 (viewer.js).

---

## Phase 6: Notes List Sidebar (~1.5h)

### Changes Required

**File: `web/notes.js`**

Right-side panel showing all annotations.

```js
export function mount(container, session, { onNoteClick })
export function update(session)   // Re-render after annotation changes
```

**Each note shows:**
- Type badge: `Comment` or `Suggest` (colored pill)
- Snippet preview: first ~60 chars of the selected text (quoted, truncated)
- Annotation text
- Delete button (√ó)

**Interactions:**
- Click note ‚Üí scroll document to highlight, pulse the highlight briefly
- Click highlight in document ‚Üí scroll sidebar to note, pulse the note
- Counter in panel header: "3 notes"

**No resolved/open status** ‚Äî single-user, no collaboration framing (debate doc Decision 7).

### Success Criteria

- [ ] Notes list updates in real-time as annotations are added
- [ ] Click note ‚Üí document scrolls to annotation
- [ ] Click highlight ‚Üí sidebar scrolls to note
- [ ] Delete note removes annotation + highlight + autosaves
- [ ] Counter updates correctly
- [ ] Empty state: "No notes yet. Select text to add a comment or suggestion."

### Dependencies

Phase 5 (editor.js ‚Äî annotations exist to display).

---

## Phase 7: "Finish Review" Export Screen (~1.5h)

### Changes Required

**File: `web/export.js`**

Export view shown when user clicks "Finish review" button.

```js
export function mount(container, session)
```

**Primary CTA 1: Copy Summary**

Human-readable summary grouped by document order:

```
## Review Summary

### Line 5-7
> "The original selected text..."
**Comment:** This paragraph needs more context about the architecture.

### Line 12
> "Another selected passage..."
**Suggestion:** Replace with: "Improved replacement text here."

---
3 notes total (2 comments, 1 suggestion)
```

One-click "Copy to clipboard" button.

**Primary CTA 2: Download .fem**

- Serialize session using `fem.serialize()` ‚Äî produces valid `.fem` file with frontmatter
- Line numbers computed at export time: convert offsets ‚Üí 1-based line numbers by counting newlines in canonical text
- Trigger browser download via `Blob` + `URL.createObjectURL`
- Filename: `review-{sessionId}.fem`

**"Back to review" link** to return to editor.

### Success Criteria

- [ ] Summary is readable, correctly grouped
- [ ] "Copy" copies to clipboard with success feedback ("Copied!")
- [ ] Downloaded `.fem` file is valid ‚Äî `just run apply` can parse it
- [ ] Offset ‚Üí line number conversion is correct
- [ ] Back button returns to editor with all state preserved

### Dependencies

Phase 2 (fem.js serialize), Phase 3 (storage.js load session), Phase 5 (annotations exist).

---

## Phase 8: Polish + Integration Testing (~2h)

### Changes Required

**Autosave indicator:**
- "Saving‚Ä¶" ‚Üí "Saved locally" transition in header
- Debounce saves to 500ms after last change

**Onboarding:**
- First-run copy on landing page (already in Phase 1)
- Tooltip on first selection: "Drag to select text, then choose Comment or Suggest"

**Mobile graceful degradation:**
- `@media (max-width: 768px)` shows "Best on desktop. You can view reviews but annotation requires a desktop browser."
- Read-only: document renders, notes list shows, but selection/toolbar disabled

**Session management (minimal):**
- Landing page shows recent sessions below the paste area (if any exist in IndexedDB)
- Click session ‚Üí resume in editor
- No delete, no multi-session management in v0

**Privacy footer (all pages):**
```
üîí Runs locally in your browser. Your text never leaves your device.
```

**Cross-browser smoke test:**
- Chrome, Firefox, Safari (desktop)
- Verify: paste ‚Üí annotate ‚Üí export ‚Üí download .fem ‚Üí parse with Go CLI

### Success Criteria

- [ ] Full user journey works end-to-end: paste ‚Üí annotate ‚Üí finish ‚Üí copy/download
- [ ] File upload journey works: drop file ‚Üí annotate ‚Üí finish ‚Üí download .fem
- [ ] `.fem` round-trip: download from web ‚Üí `just run apply review-{id}.fem` produces valid JSON
- [ ] Autosave persists across page reload
- [ ] Resume session from landing page works
- [ ] Mobile shows graceful fallback
- [ ] Privacy footer on every page

### Dependencies

All previous phases.

---

## Summary

| Phase | Deliverable | Time | Dependencies |
|-------|-------------|------|--------------|
| 1 | Scaffold + landing page | 2h | None |
| 2 | FEM parser in JS | 1.5h | None |
| 3 | IndexedDB storage | 1h | None |
| 4 | Plain-text viewer + offsets | 1h | None |
| 5 | Editor + selection + annotation | 3h | 2, 3, 4 |
| 6 | Notes list sidebar | 1.5h | 5 |
| 7 | Export / "Finish review" | 1.5h | 2, 3, 5 |
| 8 | Polish + integration test | 2h | All |

**Total: ~13.5 hours**

Phases 1‚Äì4 can run in parallel. Phase 5 is the critical path. Phases 6 and 7 can run in parallel after Phase 5.

## Risks

| Risk | Mitigation |
|------|-----------|
| Browser selection API quirks across browsers | Plain-text viewer makes selection ‚Üí offset mapping trivial; constrain to single container |
| FEM JS parser diverges from Go parser | Conformance test: export .fem from web, parse with Go CLI (Phase 8) |
| IndexedDB quota/availability | "Download your work" always available; clear messaging |
| Highlight DOM wrapping desynchronizes offsets | Re-render from canonical text on every annotation change; never mutate text nodes in place |

## Non-Goals (explicitly deferred)

- No rendered markdown (plain text only in v0 ‚Äî rendered markdown is v1, gated on offset conformance tests)
- No `.fem` import (export-only; `.fem` round-trip import is v1)
- No overlapping annotation highlight refinement (last-wins in v0)
- No WASM
- No vim/keyboard mode
- No GitHub import
- No Google Docs import
- No collaboration / share-by-link
- No mobile annotation support
- No syntax highlighting (code blocks get monospace + background only)
- No dark mode
- No build step / bundler / npm
